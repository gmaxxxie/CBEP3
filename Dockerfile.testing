# 基于 Ubuntu 和 Chrome 的测试环境
FROM ubuntu:22.04

# 设置非交互式安装
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:99

# 安装基础依赖
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    curl \
    xvfb \
    x11vnc \
    fluxbox \
    dbus-x11 \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libdrm2 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libxss1 \
    libxtst6 \
    lsb-release \
    xdg-utils \
    && rm -rf /var/lib/apt/lists/*

# 安装 Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y nodejs

# 安装 Google Chrome
RUN wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    apt-get update && \
    apt-get install -y google-chrome-stable && \
    rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /app

# 复制项目文件
COPY package*.json ./
COPY playwright.config.js ./
COPY tests/ ./tests/
COPY manifest.json ./
COPY background/ ./background/
COPY sidebar/ ./sidebar/
COPY options/ ./options/
COPY src/ ./src/
COPY assets/ ./assets/

# 安装依赖
RUN npm ci
RUN npx playwright install chromium

# 创建启动脚本
RUN echo '#!/bin/bash\n\
# 启动虚拟显示器\n\
Xvfb :99 -ac -screen 0 1280x1024x24 -nolisten tcp &\n\
export DISPLAY=:99\n\
\n\
# 等待显示器就绪\n\
sleep 3\n\
\n\
# 运行测试\n\
exec "$@"' > /entrypoint.sh && \
    chmod +x /entrypoint.sh

# 设置入口点
ENTRYPOINT ["/entrypoint.sh"]
CMD ["npm", "run", "test:e2e"]

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD google-chrome --headless --no-sandbox --disable-gpu --remote-debugging-port=9222 --version || exit 1